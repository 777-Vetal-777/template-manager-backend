<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="001-create-data-collection-file-table" author="Sergey_Nemets">
        <createTable tableName="data_collection_file">
            <column name="id" type="bigint">
                <constraints nullable="false" notNullConstraintName="data_collection_file_id_not_null_constraint"
                             primaryKey="true" primaryKeyName="data_collection_file_pk"/>
            </column>
            <column name="version" type="bigint">
                <constraints nullable="false" notNullConstraintName="data_collection_file_version_not_null_constraint"/>
            </column>
            <column name="data_collection_id" type="bigint">
                <constraints nullable="false" notNullConstraintName="data_collection_file_data_collection_id_not_null_constraint"
                             foreignKeyName="fk_data_collection_file_to_data_collection"
                             references="data_collection(id)"/>
            </column>
            <column name="created_on" type="timestamp" defaultValueComputed="current_timestamp">
                <constraints nullable="false" notNullConstraintName="data_collection_file_created_on_not_null_constraint"/>
            </column>
            <column name="author_id" type="bigint">
                <constraints nullable="false" notNullConstraintName="data_collection_file_author_id_not_null_constraint"
                             foreignKeyName="fk_data_collection_file_to_user"
                             references="user(id)"/>
            </column>
            <column name="comment" type="varchar(255)"/>
        </createTable>
    </changeSet>

    <changeSet id="002-add-unique-constraint-name-on-data-collection-id-and-version-columns-in-data-collection-file-table" author="Sergey_Nemets">
        <addUniqueConstraint tableName="data_collection_file" columnNames="data_collection_id, version" constraintName="data_collection_file_data_collection_id_and_version_unique_constraint"/>
    </changeSet>

    <changeSet id="003-data-collection-file-sequence" author="Sergey_Nemets">
        <createSequence sequenceName="data_collection_file_sequence"/>
    </changeSet>

    <changeSet id="004-data-collection-file-add-data-columns" author="Sergey_Nemets">
        <addColumn tableName="data_collection_file">
            <column name="data" type="${blob}">
                <constraints nullable="false" notNullConstraintName="data_collection_file_data_not_null_constraint"/>
            </column>
            <column name="file_name" type="varchar(255)">
                <constraints nullable="false"
                             notNullConstraintName="data_collection_file_file_name_not_null_constraint"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="005-add-data-collection-role-table" author="Ivan_Semenov">
        <createTable tableName="data_collection_role">
            <column name="data_collection_id" type="bigint">
                <constraints nullable="false" notNullConstraintName="data_collection_role_data_collection_id_not_null_constraint"
                             foreignKeyName="fk_data_collection_role_to_data_collection" references="data_collection(id)"/>
            </column>
            <column name="role_id" type="bigint">
                <constraints nullable="false" notNullConstraintName="data_collection_role_role_id_not_null_constraint"
                             foreignKeyName="fk_data_collection_role_to_role" references="role(id)"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="006-drop-fk-between-data-collection-and-template-tables" author="Yaroslav_Maievskij">
        <dropForeignKeyConstraint baseTableName="template" constraintName="fk_template_to_data_collection"/>
    </changeSet>

    <changeSet id="007-drop-data-collection-id-column-from-template-table" author="Yaroslav_Maievskij">
        <dropColumn tableName="template">
            <column name="data_collection_id"/>
        </dropColumn>
    </changeSet>

    <changeSet id="008-drop-data-column-from-data-collection-table" author="Yaroslav_Maievskij">
        <dropColumn tableName="data_collection">
            <column name="data"/>
        </dropColumn>
    </changeSet>

    <changeSet id="009-drop-file-name-column-from-data-collection-table" author="Yaroslav_Maievskij">
        <dropColumn tableName="data_collection">
            <column name="file_name"/>
        </dropColumn>
    </changeSet>

    <changeSet id="010-add-data-collection-file-id-column-to-template-table" author="Yaroslav_Maievskij">
        <addColumn tableName="template">
            <column name="data_collection_file_id" type="bigint">
                <constraints nullable="true" foreignKeyName="fk_template_to_data_collection_file" references="data_collection_file(id)"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="011-add-template-role-table" author="Ivan_Semenov">
        <createTable tableName="template_role">
            <column name="template_id" type="bigint">
                <constraints nullable="false" notNullConstraintName="template_role_template_id_not_null_constraint"
                             foreignKeyName="fk_template_role_to_template" references="template(id)"/>
            </column>
            <column name="role_id" type="bigint">
                <constraints nullable="false" notNullConstraintName="template_role_role_id_not_null_constraint"
                             foreignKeyName="fk_template_role_to_role" references="role(id)"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="012-add-deployed-column-to-template-file-table" author="Ivan_Semenov">
        <addColumn tableName="template_file">
            <column name="deployed" type="boolean" defaultValueBoolean="false"/>
        </addColumn>
    </changeSet>

</databaseChangeLog>